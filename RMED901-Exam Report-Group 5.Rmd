---
title: "RMED901-Exam Report-Group 5"
author: Alexander Vietheer, Dinastry Pramadita Zakiudin, Marta Espevold Hjelmeland
  and Shanshan Xu
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown
[Check the document](https://mitt.uib.no/groups/68014/files/folder/DATA?preview=4450357)

This is the **group 5 exam report** for the course **RMED901 22H / Data science with R for medical researchers**, we used the data set from the paper in the New England Journal of Medicine, entitled, [A Randomized Trial of Rectal Indomethacin to Prevent Post-ERCP Pancreatitis, pages 1414-1422 volume 366, 2012 edition, authored by the Elmunzer, BJ, Higgins PDR, et al.](https://www.nejm.org/doi/full/10.1056/NEJMoa1111103). 



#Loading the package for analysis
```{r}
library(tidyverse)
library(ggplot2)
library(dplyr)
library(here)
```
**1.Read the data set**
```{r}
myData <- read_delim(here("DATA", "exam_nontidy.txt"), delim = "\t")
```
**2. Clean the data set**

**#Data cleaning 1:** We observe some variables starting with number,and the variable "feature type" has space between the variable name, so we rename these by using the pipe-rename.
```{r}
myData <- myData %>% 
  rename(Dose_asa_81 = `81asa`,
         Dose_asa_325 = `325asa`,
         feature_type = `feature type`)
```
**#Data cleaning 2:** We observed the variable "id" has the two parts, we checked the codebook of the dataset, the first integer 1-4 indicates site of the study so we use separate() function to separate the id column
```{r}
myData <- myData %>% 
  separate(col = id, 
           into = c("site", "id"), 
           sep = "_")
```
**#Data cleaning 3:** Remove the duplicated row in the dataset using the distinct() function (there are 10 rows with duplicates)
```{r}
myData <- myData %>% 
  distinct()
```
**#Data cleaning 4:** Then we pivot the "feature_type" column into sod and pep columns
```{r}
myData$feature_type <- as.factor(myData$feature_type)
myData$feature_value <- as.numeric(myData$feature_value)
myData <- myData %>% 
  pivot_wider(names_from = `feature_type`, values_from = feature_value)
```
**#Data cleaning 5:** Check the missing data
```{r}
naniar::gg_miss_var(myData) 
```

**#Data cleaning 6:** Remove unnecessary columns from your dataframe: acinar, train, amp, pdstent. Use subset() fuction to delete column by name
```{r}
df=subset(myData, select = -c(acinar, train, amp, pdstent))
```

#df is the data frame excluded the cloumns:acinar, train, amp, pdstent from the day 6 task.

**3. Change the variable types:** Make necessary changes in variable types

#A column showing whether age is higher than 35 or not: values High/Low
```{r}
myData <- myData %>% 
  mutate(agegroup = case_when(age <= 35 ~ "Low",
                              age > 35 ~ "High"))
```
#A numeric column showing risk as a percentage of highest possible risk (5.5)
```{r}
myData$risk <- as.numeric(myData$risk)
myData <- myData %>% 
  mutate(riskpercentage = risk / 5.5)
```
#A column showing pep as No/Yes
```{r}
myData <- 
  myData %>% 
  mutate(Newpep = pep, Newpep = if_else(Newpep == "0", "No", "Yes"))
```
#A numeric column showing multiplication of age and risk for each person
```{r}
myData$age<-as.numeric(myData$age)
myData <- myData %>% 
  mutate(AgemultiplybyRisk = age*risk )
```
**4. Change the order of the column as id, site, age and other columns; and arrange id column of the dataset in the order of increasing number**
```{r}
myData <- myData %>% 
  select(id, everything())
arrange(myData, id)
```
**5. Combine the two data sets.**

#Read the additional dataset
```{r}
antibodyData <- read_delim(here("DATA", "exam_joindata.txt"), delim = "\t")
```
#Separate the columns "id" in the "joindata" dataset.
```{r}
antibodyData <- antibodyData %>% 
  separate(col = id, 
           into = c("site", "id"), 
           sep = "_")
```
#Combine the two datasets using pipe.
```{r}
Fulldataset <- myData %>% 
  left_join(antibodyData, by = c("id","site"))
```
#The Fulldataset contains n = 602 observations and 37 variables. We will work on this Fulldataset.

#Exploring the data. We observed there are many missing data (402) from antibodyData especially in female
```{r}
sum(is.na(Fulldataset))
naniar::gg_miss_var((Fulldataset), facet = gender)
```



#Group the data by gender. We had 476 females and 126 males, this could be why there was a big difference in missing data between the genders.
```{r}
Fulldataset %>% 
  group_by(gender) %>% 
  count()
```

#Stratify the data by a categorical column and a report of min, max, mean and sd of a numeric column.
```{r}
Fulldataset %>% 
  group_by(gender) %>% 
  summarise(min(risk, na.rm = T),max(risk, na.rm = T), mean(risk, na.rm = T), sd(risk, na.rm = T))
```

## Data cleaning 3: remove the duplicated row in the dataset using the distinct() function}
```{r}
myData<- myData %>% 
  distinct()
```
### there are 10 rows with duplicates final n = 1204 

## Tidy 4: Then we pivot the column into sod and pep columns
```{r}
myData$feature_type <- as.factor(myData$feature_type)
myData$feature_value <- as.numeric(myData$feature_value)
myData <- myData %>% 
  pivot_wider(names_from = `feature_type`, values_from = feature_value)
```

#Stratify the data using pipe by a categorical column and a report of min, max, mean and sd of a numeric column for a defined set of observations
```{r}
Fulldataset %>% 
  group_by(gender) %>% 
  summarise(min(antibody, na.rm = T),max(antibody, na.rm = T), mean(antibody, na.rm = T), sd(antibody, na.rm = T))
```


#Stratify the data only for persons with no recurrent pancreatitis
```{r}
Fulldataset %>% 
  filter(recpanc == 0)
```

#Stratify the data only for persons recruited in University of Kentucky
```{r}
Fulldataset %>% 
  filter(site == 3)
```

#Startify the data only for persons older than 45
```{r}
Fulldataset %>% 
  filter(age > 45)
```

#Stratify the data only for persons with risk higher than 2 and sphincter of Oddi dysfunction type 2. We observed no patients fall in this category
```{r}
Fulldataset %>% 
  filter(risk > 2 & sod_type ==2)
```

#Explore the data by creating a table to observe gender and sphincter of Oddi dysfunction type 
```{r}
Fulldataset %>% 
  select(gender, sod_type) %>% 
  count(gender, sod_type)
```

##adding extra libraries
```{r}
library("patchwork")
library("ggplot2")
library("corrplot")
```

#1.Are there any correlated measurements?

##In our data set, only the age, antibody and risk are the numeric variables,so we can explore the correlation betwwen age, risk, antibody. So we will plot the correlations between age, risk and antibody
##We can check the correlation by plotting the scatter plot of two variables first:

```{r}
scatterplot1 <- ggplot(data = Fulldataset) + geom_point(mapping = aes(x = age, y = risk))
scatterplot1
scatterplot2 <- ggplot(data = Fulldataset) + geom_point(mapping = aes(x = age, y = antibody))
scatterplot2 
scatterplot3 <- ggplot(data = Fulldataset) + geom_point(mapping = aes(x = risk, y = antibody))
scatterplot3 
```
###From the scatter plots, did not see a very clear relationship between age, risk and antibody.

#Then we create datafram of these three columns and then plot a correlation matrix.
```{r}
library(corrplot)
df1 <- Fulldataset %>% select(c(age,risk,antibody))
correlationmatrix <- corrplot(cor(df1,use="pairwise.complete.obs" ),
         addCoef.col = "black",
         number.digits =  3,
         outline = "black")
```
##age and risk were weakly negatively correlated, antibody did not show statistically significant correlation with age or risk.

#2.Does the age distribution depend on sod_type? 
##age is numeric and sod_type is categorical
```{r}
ggplot(Fulldataset,
       aes(x = sod_type, y = age)) +
  geom_col(aes(sod_type))
```
###It looks like there is an higher number of older patients with Type2. 

#Might this only depend on the higher number of older patient? Creating a boxplot to get an impression of the median: 
```{r}
ggplot(Fulldataset,
       aes(x = sod_type, y = age)) +
  geom_boxplot(aes(sod_type))
```
###In this dataset, the age tend to be older in Type1 than Type2 and 3. 

##3.Does the age distribution of the patients depend on their sex (gender)?
```{r}
ggplot(Fulldataset,
       aes(x = as.factor(gender), y = age)) + 
  geom_col(aes(fill = age), position = position_dodge()) +
           facet_wrap(facets = vars(gender)) 
```
### The patients were older in the female group, and younger in the male group.

#4.Does the risk score change with age of the patients? 
##Both variables are numerical
```{r}
ggplot(Fulldataset,
       aes(x = age, y = risk)) +
  geom_point(aes(age)) +
  geom_smooth(method = "lm")
```
# it does look like that there is a relation between risk and age.  

#5.Does the aspirin usage depend on the age? 
```{r}
skimr::skim(myData$Dose_asa_81)
skimr::skim(myData$Dose_asa_325)
skimr::skim(myData$age)
head(Fulldataset$Dose_asa_81)
head(Fulldataset$age)
glimpse(Fulldataset$age)
```

#Using Fulldataset
```{r}
library(tibble)
library(MASS) # for ordinal log regression
```
##checking if anyone taking both 81 and 325 mg aspirin (should be FALSE if nobody took both)
```{r}
Fulldataset <- Fulldataset %>% add_column(checkAspUse = ifelse(Fulldataset$Dose_asa_81==1&Fulldataset$Dose_asa_325==1,1,0))
1 %in% Fulldataset$checkAspUse
```
###Return FALSE: Nobody taking both aspirin dose 81 and 325 mg

```{r}
summary(Fulldataset$checkAspUse)
```
###Nobody taking both aspirin dose 81 and 325 mg
```{r}
summary(Fulldataset)
```

##Converting (but creating a new variables to be safe, not changing the original ones) to factor
```{r}
Fulldataset$Asa81Fac <- as.factor(Fulldataset$Dose_asa_81)
Fulldataset$Asa325Fac <- as.factor(Fulldataset$Dose_asa_325)
```
### To remove E-10212 bla bla (scientific notations on decimals)
```{r}
options(scipen=999)
```
###Setting model ASA81
```{r}
modelAsa81 <- glm(Asa81Fac ~ age, family='binomial', data=Fulldataset)
summary(modelAsa81)
```

#model ASA325
```{r}
modelAsa325 <- glm(Asa325Fac ~ age, family='binomial', data=Fulldataset)
summary(modelAsa81)
```


###Standard boxplot aspirin dose 81 mg
```{r}
boxplot(age ~ Asa81Fac, data=Fulldataset, xlab='Aspirin 81 mg Yes(1) No(0)',
        ylab='Age',
        main='Boxplot aspirin 81 mg and age')
```
###Standard boxplot aspirin dose 325 mg
```{r}
boxplot(age ~ Asa325Fac, data=Fulldataset, xlab='Aspirin 325 mg Yes(1) No(0)',
        ylab='Age',
        main='Boxplot aspirin 325 mg and age')
```
###Since nobody taking both 81 AND 325 mg, you can actually combine these two variables into e.g. 0 = no Asp, 1 = Asp 81, 2 = Asp 325. However, to test if the association is significant/not, you'll need to use orginal logistic regression (since the dependent/outcome variable is not binary).

###Converting Aspirin to categorical with 3 categories
```{r}
Fulldataset <- Fulldataset %>% 
  add_column(CheckCatAsp = 
              ifelse(Fulldataset$Dose_asa_81==1,1,                                                               ifelse(Fulldataset$Dose_asa_325==1,2,0)))

Fulldataset$CheckCatAsp <- as.factor(Fulldataset$CheckCatAsp)
```
###Creating plot for ordinal aspirin
```{r}
ggplot(Fulldataset, aes(x=CheckCatAsp, y=age)) +
  geom_boxplot(size=.75) +
  geom_jitter(alpha=.5) +
  xlab('Aspirin, none (0), 81 mg (1), 325 mg (2)') +
  ylab('Age')

```
#Boxplot
```{r}
ggplot(Fulldataset, aes(x=CheckCatAsp, y=age)) +
  geom_boxplot(size=.75) +
  xlab('Aspirin, none (0), 81 mg (1), 325 mg (2)') +
  ylab('Age')
```
###It seems from boxplots the use of aspirin is increasing with age and the dosage as well, the older the higher dose 
